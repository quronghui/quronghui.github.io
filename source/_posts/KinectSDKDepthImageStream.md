---
layout: post
title: Kinect SDK for DepthImageStream
date: 2019-02-27 16:46:00
categories: 
 - [Kinect SDK]
 - [Kinect]
 - [c++]
tags: kinect
---

# Kinect SDK for DepthImageStream

- [网上的知识点](https://blog.csdn.net/cz19800823)
- KinectSensor的最主要功能之一就是能够产生三维数据，它有红外发射器和红外摄像头。
- 介绍了Kinect红外传感器，景深数据格式，景深图像的获取与展示，景深图像的增强处理

## ColorImageStream 数据流的获取

1. DepthImageStream和ColorImageStream都继承自ImageStream
2. 景深影像数据从DepthImageFrame产生，它由DepthImageStream对象提供

### 景深帧数据

{% asset_img camera.png %}

1. 红外摄像机的视场是金字塔形状的。离摄像机远的物体比近的物体拥有更大的视场横截面积。这意味着影像的高度和宽度，比如640X[**48**](http://www.hqew.com/tech/qtdz/200010160031/1554819.html)0和摄像机视场的物理位置并不一一对应。

2. 深度帧数据中，每个像素占16位，这样BytesPerPixel属性，即每一个像素占2个字节。每一个像素的深度值只占用了16个位中的13个位。

   ​	{% asset_img frame.png %}

3. 深度值存储在第3至[**15**](http://www.hqew.com/tech/dzg/200010140014/756768.html)位中，要获取能够直接使用的深度数据需要向右移位

4. SDK在DepthImageFrame类中定义了一个常量PlayerIndexBitmaskWidth，它定义了要获取深度数据值需要向右移动的位数。

### UI界面显示

1. 在UI界面中Image空间的属性中，宽度和高度是硬编码的。如果不设置值，那么空间会随着父容器（From窗体）的大小进行缩放，如果空间的长宽尺寸和深度数据帧的尺寸不一致，当鼠标点击图片时，代码就会返回错误的数据，在某些情况下甚至会抛出异常。

## 景深图像处理

### 增强灰度级

1. 增强深度值图像：
   + 按位翻转像素值。
   + 图像的颜色是基于深度值的，他们从0开始。在数字光谱中0表示黑色，65536(16位灰阶)表示白色。
   + 所有的不能确定深度值的数据都设置为了0

### 增强深度值图像 

1. 格式的转换
   - 彩色影像的格式为了Bgr32位，每一个R,G,B分别占8位，剩余8位留用
   - 这种模式限制了RGB的取值为0-255，所以需要将深度值转换到这一个范围内。
   - 将深度值除以4095（13位的深度值，[2^13 -1]  / 2），然后乘以255，这样就可以将深度数据转换到0至255之间了.

### 数据的处理

1. 每一次当KinectSensor触发frame-ready事件时，代码顺序存储彩色影像。转换完成后，backgroud线程使用WPF中的Dispatcher来更新UI线程中Image对象的数据源。
2. 这种异步的操作在基于Kinect开发的应用中很常见，因为获取深度数据是一个很频繁的操作。如果将获取数据以及对数据进行处理放在主UI线程中就会使得程序变得很慢。

## 景深数据处理

1. Kinect深度值最大为4096mm，0值通常表示深度值不能确定，一般应该将0值过滤掉。[微软](https://www.baidu.com/s?wd=%E5%BE%AE%E8%BD%AF&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd)建议在开发中使用[1220mm（4'）~3810（12.5')范围内的值。在进行其他深度图像处理之前，应该使用阈值方法过滤深度数据至1220mm-3810mm这一范围内。

2. 可以绘制直方图

### Opencv 处理景深数据处理

1. 基于Kinect的应用程序不会对深度数据进行很多处理。如果要处理数据，也应该使用一些类库诸如OpenCV库来处理这些数据。
2. 应用程序处理深度数据目的是用来确定人体在**Kinect 视场中的位置**。

### 对物体进行测量

+ [ c# 例子代码参考 ](https://blog.csdn.net/cz19800823/article/details/11639761)

1. 每一个摄像机都有视场，焦距的长度和相机传感器的大小决定了视场角。Kinect中相机的水平和垂直视场角分别为57°和43°。

   {% asset_img test.png %}

2. 知道了底边的长度，我们就可以将像素的宽度转换为现实中的宽度。

   ```
   （1）计算出等腰三角形底边的宽度为1500mm；
   （2）游戏者所占有的总象元的宽度为100；
   （3）深度影像数据的总象元宽度为320；
   实际宽度：（1500 / 320）*100 = 468.75mm
   ```

3. 实现方式

   + 1）先创建一个新的项目然后编写发现和初始化KinectSensor的代码，将DepthStream和SkeletonStream均初始化，然后注册KinectSnsor的DepthFrameReady事件。
   + 2）CalculatePlayerSize方法遍历深度图像中的象元，然后提取游戏者索引位及其对应的深度值。
   + 3）对于游戏者的每一个象元，方法调用PlayerDepthData对象的UpdateData方法。处理完所有象元之后，将游戏者数组复制给名为PlayerDepthData的ItemControl对象的数据源。

4.  本文首先介绍了关于景深数据的简单图像数据，包括景深数据的直方图显示以及一些图像处理相关的算法，然后介绍了景深数据中的游戏者索引位，借助索引位，我们实现了人物宽度和高度的计算，最后借助景深数据结合彩色影像数据，将景深影像和视频图像进行了叠加。