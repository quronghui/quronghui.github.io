---
layout: post
title: Tcp Ip
date: 2019-05-06 15:35:12
categories:
- [TCP/IP]
- [LinuxC]
tags: TCP/IP
---

# TCP / IP 协议

## TCP/IP 协议栈

1. 协议栈的划分

   {% asset_img protocol_stack.png %}

2. TCP/IP 通信的过程

   + 传输层及其以下：的机制由内核提供；处理通信细节
   + 应用层：由用户进程提供；对通讯数据的含义进行解释（处理应用程序细节）

3. TCP/IP 数据包的封装

   + 应用层数据通过协议栈发到网络上时，每层协议都要加上一个数据首部(header),称为封装

   {% asset_img data_pack.png %}

   + 数据包称呼：不同的协议层对数据包有不同的称谓
     + 在传输层叫做段(segment)
     + 在网络层叫做数据报(datagram)
     + 链路层叫做帧（frame）
   + 数据封装成帧后发到传输介质上，到达目的主机后每层协议再剥掉相应的首部,最后将应用层数据交给应用程序处理。

4. 数据包的通讯

   + 经过多个路由器才能到达目的主机

   + 物理层： ---  传输
     + 是电信号的传递
     + 物理层：决定了最大传输速率、传输距离、抗干扰性等
     + 集线器(Hub)：将衰减信号放大；广播通信
   + 链路层：---  通道检测
     + 负责网卡设备的驱动、帧同步、冲突检测
     + 交换机：可以在不同的链路层网络之间转发数据帧；
       + 记录MAC地址表，Mac查找通信
   + 网络层：IP
     + Internet上的主机通过IP地址来标识
     + 路由器：根据IP地址选择合适的路径转发数据包
       + 兼有交换机的功能：不同的链路层接口之间转发数据包
       + IP协议不保证传输的可靠性
     + 网络层：负责点到点(point-to-point)的传输(这里的“点”指主机或路由器)
   + 传输层：TCP/UDP
     + 传输层负责端到端(end-to-end)的传输：(这里的“端”指源主机和目的主机)
     + TCP：传输的双方需要首先建立连接，数据传输有序
     + UDP：UDP协议不面向连接,也不保证可靠性,

5. 目的主机对数据包的解析

   + 以太网驱动程序：确定**数据帧**的归属
   + 网络层的IP协议：确定**数据报**的归属
   + 传输层的TCP或UDP协议：确定**端口号**的归属

   {% asset_img multiplexing.png %}

## 以太网（RFC）帧格式

1. 以太网的首部：14 byte

   + **先是**目的地址：6 byte
   + **后是**源地址：6 byte
   + 类型：2byte --  0x0800表示IP

2. 以太网的帧格式

   + 源地址和目的地址是指网卡的硬件地址(也叫MAC地址)，长度是48位

     ```
     $ ifconfig	// 查看“HWaddr 00:15:F2:14:9E:3F”部分就是硬件地址。
     ```

   + 以太网帧中的数据长度规定最小46字节,最大1500字节

     + ifconfig 中的 “MTU:1500”。

   + ARP和RARP数据包的长度不够46字节,要在后面补填充位。

   {% asset_img RFC.png %}

### ARP 数据报文格式

1. ARP的作用

   + 报文的解析是一层层往上的，在网络通讯时，源主机的应用程序知道目的主机的IP地址和端口号，却不知道目的主机的硬件地址。
   + ARP的作用便是：广播 询问 IP 地址对应的硬件地址是多少
   + ARP请求的广播帧无法穿过路由器，同一个局域网才能起作用
   + 每台主机都维护一个ARP缓存表,可以用arp -a命令查看。  

2. ARP报文格式

   {% asset_img ARP.png %}

   + 以太网规定最小数据长度为46字节,ARP帧长度只有28字节,因此有18字节填充位，填充位的内容没有定义
   + 以太网首部：上层协议类型0x0806表示ARP
   + ARP帧：
     + 硬件类型0x0001表示以太网,
     + 协议类型0x0800表示IP协议,
     + 硬件地址(MAC地址)；协议地址(IP地址)
     + op为0x0001表示请求目的主机的MAC地址

## IP 数据报

### IP数据报文格式

1. 数据包的首部长度最小是20 byte；最大是60 byte
2. 从后往前数：源、目的IP地址 各占4byte
3. 数据报文的格式：十六进制表示；
   + IP地址表示：十进制

### IP地址与路由

1. IP地址

   + 32位的IP地址：划分网络号和主机号
   + 分位5类（每增加一位 -- 首位固定值，主机号的字节将减少1byte）

   ```
   IP 140.252.20.68/24		// 表示网络号是24位，全为1 255.255.255.0
   ```

2. loopback

   + loopback是系统中一种特殊的网络设备
     + 如果发送数据包的目的地址是环回地址
     + 或者与本机其它网络设备的IP地址相同，则数据包不会发送到网络介质上
   + 127.* 的IP地址用于本机回环：127.0.0.1

3. 不能用作主机IP地址的特殊地址

   + 示本网络内部广播：255.255.255.255
   + 主机号全为0的地址只表示网络而不能表示某个主机：192.168.10.0
   + 目的地址的主机号为全1,表示广播至某个网络的所有主机：192.168.10.255

4. ifconfig and route

   + 同一个网络中：可以直接发到目的主机,不需要经路由器转发。
   + 不同网络：首先发到路由器，再让路由器根据它的路由表决定下一跳地址。

## TCP / UDP

### UDP

1. UDP段格式

   + 源端口号、目的端口号：各  2 byte
   + 长度和校验和：各  2 byte

2. TFTP是基于文本的协议

   + 各字段之间用字节0分隔
   + 开头的0x 00 01表示请求读取一个文件

3. 网络通信

   + 像TFTP协议这样
     + Client
     + Server
   + IP/port：表示对应的进程
   + Client：通信开始的时候需要知道server 的IP/port

4. 服务的端口号

   + HTTP服务默认TCP协议的80端口
   + FTP服务默认TCP协议的21端口
   + TFTP服务默认UDP协议的69端口

   ```
   $ man ftp	// 指定端口号
   ```

### TCP

1. TCP的段格式

   + 源端口号、目的端口号：各  2 byte
   + 序列号 和 确认序列号：各 4 byte
   + TCP 4位首部长度和IP协议头类似,表示TCP协议头的长度；TCP协议头20 -- 60字节,

2. TCP 通讯时序

   {% asset_img tcp_communication.png %}

   + 建立连接

     + SYN：占一位，表示连接请求
     + mss：允许的最大字节数 
     + 三个段：三次握手
       + client：请求段和应答段
       + server：请求和应答在一个段中发出
     + telnet ip port

   + 数据传输

     + ACK和确认序号是非常重要的
     + client：先发数据；确认server的ACK 
     + server: 确认client的ACK 和 数据是一起发送

   + 关闭连接

     + FIN ：占一位，FIN位表示关闭连接的请求

     + 建立连接的过程是三方握手,而关闭连接通常需要4个段

     + client：请求FIN；确认server的ACK

     + server：应答ACK 和 关闭连接FIN请求通常不合并在一个段中

       + 连接半关闭的情况

       

3. 滑动窗口

   + 解决数据丢失的问题
   + TCP协议是面向流的协议，应用程序所看到的数据是一个整体，可以是几K数据，也可以是几个字节数据
   + 而UDP是面向消息的协议，每个UDP段都是一条消息,应用程序必须以消息为单位提取数据,不能一次提取任意字节的数据,这一点和TCP是很不同的。