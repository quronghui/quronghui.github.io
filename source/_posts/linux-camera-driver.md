---
layout: post
title: linux_camera_driver
date: 2019-09-04 20:11:43
categories: [driver]
tags:	[camera]
---

# [Linux camera driver](https://blog.csdn.net/fengyuwuzu0519/article/details/73610813)

##   Camera驱动接口

| 接口     | CSI                                               | I2C                                        |
| -------- | ------------------------------------------------- | ------------------------------------------ |
| 接口作用 | 用于Camera**感光器件**数据本身的传输              | 用于**控制**数据的传输                     |
|          | 摄像头感光器件本身**数据传输**的相关代码          | **设置**曝光时间设置，图像大小设置，白平衡 |
| 实体     |                                                   | OV系列的驱动                               |
| 驱动代码 | 平台(CPU)一旦确定：这部分的**驱动代码**就基本确定 | 根据**不同的接口**有不同的驱动代码         |
|          |                                                   |                                            |

1. 不同的camera开发，需要关注的是？
   + 具体摄像头的控制**接口**部分，I2C,SPI
   + 不同的摄像头，**设置白平衡等**功能的方式不一样

2. CSI代码主要的职责
   + 按照平台内的CSI控制器的特点，完成CSI控制寄存器的配置
   + CSI中断服务例程的实现以及具体数据传输（内存分配,DMA数据传输等）的实现

### 其他的接口驱动：USB和PCI

1. **驱动初始化阶段**：通过probe方法获得相关寄存器的访问地址，之后参照datasheet进行寄存器配置
2. **数据处理**：再结合Linux系统的**中断机制和数据传输机制**（DMA和MMAP）

##  V4L2架构

{% asset_img V4L2.png %}

### V4L2 支持 -- 视频输入输出设备四部分

| 四个模块         | 功能                                                         |
| ---------------- | ------------------------------------------------------------ |
| 字符设备驱动程序 | V4L2是一个字符设备，具有字符设备的特性，向上提供接口给用户空间； |
| V4L2驱动核心     | 构建内核中标准视频设备驱动框架，为设备提供统一的接口函数     |
| 平台V4L2设备驱动 | 在V4L2框架下：实现与平台相关的V4L2驱动部分，包括注册**video_device和v4l2_dev**结构体 |
| 具体的sensor驱动 | 上电、提供工作时钟、视频图像裁剪、流IO开启等，实现各种设备控制方法供上层调用并注册v4l2_subdev。 |

{% asset_img V4L2_architeture.png %}

### V4L2的核心源码

1. 源码查看

   ```
   cd 		/driver/media/v4l2-core		// 进入v412框架的代码
   ```

2. 代码目录

   
   
   | 模块         |                                                              | 函数                                                  |
   | ------------ | ------------------------------------------------------------ | ----------------------------------------------------- |
   | 核心模块     | 申请字符主设备号，注册class<br />和提供video_device**注册注销**函数 | v4l2-dev.c                                            |
   | V4L2框架     | 构建V4L2框架                                                 | v4l2-device.c、v4l2-subdev.c、v4l2-fh.c、v4l2-ctrls.c |
| Videobuf管理 | 完成**videobuffer**的分配、管理和注销                        |                                                       |
   | Ioctl框架    | 构建V4L2 **ioctl**的框架                                     | v4l2-ioctl.c                                          |

   + Videobuf 函数
   
     ```
     由videobuf2-core.c、videobuf2-dma-contig.c、videobuf2-dma-sg.c、videobuf2-memops.c、videobuf2-vmalloc.c、v4l2-mem2mem.c
     ```

### V4L2 两个结构体

| 结构体               | 树型结构                                                     |
| -------------------- | ------------------------------------------------------------ |
| v4l2_device - 父结构 | **对子设备管理**：通过链表将所有注册的子设备进行管理         |
|                      | V4l2_subdev是子设备                                          |
|                      | 设备：可以是GRABBER、VBI或RADIO                              |
| Video_device         | 创建子设备节点，把操作设备的接口提供给用户空间               |
|                      | V4l2_fh：是每个子设备的**文件句柄**，在打开设备节点文件时设置 |
|                      | v4l2_ctrl_handler：通过V4l2_fh，进行子设备控制               |

1. V4l2_subdev是子设备作用？

   + 包含了对设备操作的ops 和 ctrls
   + 实现控制上下电、读取ID、饱和度、对比度和视频数据流打开关闭的接口函数

2. V4L2驱动的实现

   {% asset_img v4l2_realize.png %}