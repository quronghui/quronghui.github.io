---
layout: post
title: 进程间通信的几种方式
date: 2019-08-02 08:55:26
categories:	[Operate System]
tags:	process
---

# [进程间通信的几种方式](https://www.jianshu.com/p/c1015f5ffa74)

1. 为什么进程间通信需要**内核**?

   - IPC (InterProcess Communication) 通信机制
     - 进程各自有不同的用户地址空间, 任何一个进程的全局变量在另一个进程中都看不到
     - 进程之间要**交换数据**必须通过内核，在内核中开辟一块**缓存区**

   {% asset_img interProcessCommunication.png %}

2. 进程间通信方式的总结

   

   | 类型                 | 属性 / 存在地方                      | 通信要求                                  | 数据流向                                 |
   | -------------------- | ------------------------------------ | ----------------------------------------- | ---------------------------------------- |
   | **传统的通信方式**   |                                      |                                           |                                          |
   | 匿名管道(pipe)       | **内存中**的文件                     | 亲缘关系 / 双方存在 (**同步**)            | **数据拷贝** / FIFO顺序                  |
   | FIFO有名管道         | **磁盘**介质或者内存中               | 只要能访问**路径** / 双方存在 (**同步**)  | **数据拷贝**/ FIFO顺序                   |
   | 信号(Signal)         | 对**中断机制**的一种模拟             | 任何时候 (**异步**)                       |                                          |
   | **System v IPC对象** |                                      |                                           |                                          |
   | 消息(Message)队列    | 内存, **特定数据格式**的**消息链表** | 异步通信 / **多进程**访问                 | **多数据拷贝** / FIFO写入, lessk访问读取 |
   | 共享内存             | 内核留出一块**共享内存区**           | 异步通信 / **多进程**访问                 | **空间映射** / 信号量进行同步            |
   | 信号量(semaphore)    | **是一个计数器**                     | **同步**多进程对**共享数据**(内存)的访问; | **互斥和同步**                           |
   | **网络通信**         |                                      |                                           |                                          |
   | 套接字               | **通信**机制, TCP/IP操作单元         | **client / server**进行通信               | 套接字的三个特性                         |

## 传统的进程间通信方式

### 管道/匿名管道(pipe)

- **pipe本质**: 是一类特殊的文件, 只存在于**内存中**(内核缓存区)的文件, 
- **数据流向** : 管道是**半双工**的
  - 进程以**FIFO读写数据**(循环队列), 有一定的机制判断队列的满和空, 通知等待进行
  - 数据只能向一个方向顺序流动, 不支持lseek()偏移量读取
- **无名pipe 通信要求**: 
  - 只能用于父子进程或者兄弟进程之间(具有**亲缘关系**的进程);
  - 在进行读写时, **通信双方都需存在**, 否则会退出; 
- **文件系统**: 独立的文件系统, 只存在与**内存中**
- **阻塞情况处理**: 循环队列都为空, 如果进程去读; 或者都为满时进程去写, 会发生阻塞;

1. [题目一: 实现通过pipe进行进程间的通信?](http://blog.chinaunix.net/uid-26833883-id-3227144.html)

### 有名管道(FIFO)

- 与无名管道的区别: **有名pipe**, 将路径名和pipe进行关联;
  - **名字存储**: 存在于实际的磁盘介质或者内存中的文件系统;
  - **通信要求**: 进程只要能访问路径, 就能通过pipe进行通信; 双方必须存在;

1. [题目一: 实现进程间通过FIFO通信的编程题?](http://blog.chinaunix.net/uid-26833883-id-3227144.html)

### 信号(Signal)

- **signal本质**:  软件层次对**中断机制**的一种模拟,  异步通信方式;

  - 异步通信: 信号在任何时候可以选择发送, **无需知道**进程的状态;
  - 通信双方: 进程之间 <--------> 内核之间交互

- **信号产生** : 软硬件的终止 / 异常;

  - 硬件来源:  用户输入Ctrl + C 退出, 硬件异常如无效的存储访问;
  - 软件来源:  终止进程信号, 其他进程调用kill函数, 软件异常信号

- **信号的处理流程**

  - (1)进程**产生**信号, 设置信号传递的目的对象(pid), 先由**OS(操作系统)接收**
  - (2)OS**选择性**: 阻塞或者传递信号;
  - (3)目的进程接收到信号, 进行**上下文切换**(保护上下文), 完成信号操作后返回;

  {% asset_img signal.png %}

- **signal 阻塞**

  - 信号被阻塞时, **内核**先保留信号, 直到解除阻塞的状态后, 信号继续传递;

- linux_signal

  {% asset_img linux_signal.png %}



## System v IPC对象

### **消息(Message)队列**

- **本质**: 是存放在内存中, 具有**特定的格式**, 由标识符进行标识的**消息链表**
  - 异步通信机制, 无需等待读取;
  - 多端访问: 允许一个或者多个进程向消息队列写入或者读取;
- **数据流向:** FIFO的数据写入, 支持消息的**随机查询**, 支持**偏移访问**
- **优势: **
  - 克服: **信号**承载的信息少;  
  - 克服:  pipe 承载的数据是**无格式**的字节流, 缓存大小**受限**;
- **两种类型的消息队列**
  - POSIX 消息队列;
  - System V 消息队列:  存在于**内核**之中, 生命周期和内核相关, 只有当内核重启或者人工删除, 消息队列才会删除;

1. [题目一: 通过消息队列实现进程间通信?](https://blog.csdn.net/yang_yulei/article/details/19772649)

### 共享内存

- **本质: ** 内核留出一块**共享内存区**, 进程将其**映射**到自己的私有空间, **多个进程**可以读写同一块内存空间, 无需数据拷贝;
- 进程间的同步和互斥: 信号量(semaphore)

1. [题目一: 通过共享内存实现进程间通信?](https://www.cnblogs.com/linuxbug/p/4882776.html)

   {% asset_img share_message.png %}

### 信号量(semaphore)

- **本质** : 是一个**计数器**, 用于记录信号量的值, 用于**同步**多进程对**共享数据**(内存)的访问;

- 通过信号量实现多进程通信, 需要哪几步?

  - **创建一个信号量**：这要求调用者指定**初始值**，非零整数值 / 二值信号量(0/1)
  - **等待一个信号量**：该操作**测试**信号量的值，如果小于0，就阻塞。也称为**P操作**( Proberen 测试 )
  - **挂出一个信号量**：该操作将信号量的**值加1**，也称为**V操作**(verhogen 增加)
  - 信号量值的操作: **测试和加1**属于原子性的, 通过 wait(semap), signal(semap)

- **同步和互斥的概念**

  
  
  | 区别之处   | 互斥                                     | 同步                                         |
  | ---------- | ---------------------------------------- | -------------------------------------------- |
  | 定义       | 某一资源, 同一时间, 只能由一个访问者访问 | 在互斥的基础上, 机制使访问者有序访问         |
  | 特性       | 唯一性和排它性, **访问者无序**           | 互斥特性 + **有序访问  **                    |
  | 本质区别   | 用于线程间互斥                           | 用于线程见得同步                             |
  | 初始值     | 二值信号量（0 / 1）                      | 非零整数值( value >= 0 )                     |
  | 操作线程数 | 同一线程 : lock , unlock                 | Ａ线程: 释放sem_post;  B 线程: 获取sem_wait; |
  
- [信号量实现生产者和消费者模式](https://github.com/quronghui/OSIntroduction/tree/master/3_semaphore/sem_ProductAndConsume.c)

  - a. 信号量的初始值进行标识: 何时producter能进入buffer?    何时consumer能进入buffer?
    - 定义两个信号量: empty , full
    - 定义一个互斥锁, 用于保护临界区代码
  - b. 信号量:要具有指向性:
    - 消费者不能指向消费者, 只能指向生产者;
  - c. 全局变量: 存放在程序代码区(静态)
  - d. 还要加一个二值信号量 : 锁 (应对多生产者的情况)
  - e. 二值信号量放置的位置, 会造成死锁的状况;(先判断buffer是否为空, 在获取一个锁)

## 网络通信

### 套接字

- 本质: 是一种**通信**机制, 通过**网络**实现不在同一主机上的**client / server**进行通信

  - TCP/IP网络通信的基本操作单元;

- 套接字的三个特性

  - 套接字的域: 通信中使用的**网络介质**
    - **AF_INET(Internet网络)**: server绑定一个端口，在指定的端口**监听**client的连接。
    - **AF_UNIX** (unix文件系统): 文件输入/输出，而它的**地址**就是**文件名**;
  - 套接字端口号
    - TCP/IP网络通讯的程序(进程)都被赋予了唯一的端口和端口号
    - 端口: 是一个信息缓冲区，用于保留Socket中的输入/输出信息
    - 端口号: 是一个16位无符号整数(0-65535)，以区别主机上的每一个程序
  - 套接字的协议
    - **流套接字**: 通过TCP/IP连接实现，同时也是AF_UNIX中常用的套接字类型, 可靠协议
    - **数据报套接字**: UDP/IP协议实现, 不可靠
    - **原始套接字**: 允许对较低层次的协议直接访问，比如IP、 ICMP协议
      - 网络监听技术 : 很大程度上依赖于SOCKET_RAW
      - 原始套接字: 可以读写内核没有处理的IP数据包，而流套接字只能读取TCP协议的数据，数据报套接字只能读取UDP协议的数据;

  1. [题目一: 套接字的建立和通信方式]()