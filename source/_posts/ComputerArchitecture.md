---
layout: post
title: Computer Architecture
date: 2019-03-14 10:34:32
categories: 
 - [LinuxC] 
 - [Emededded]
 - [Architecture]
tags: [Linux, C]
---

# Computer Architecture

+ Von Neumann 体系结构主要由CPU(processor) + Memory ( data + fetch ) 
+ 数据的存储，访问和管理

## 内存和地址

1. 地址
   + CPU通过address找到存储单元，每个存储单元只能存一个byte，将数据放入存储单元中。
2. 内存
   + 内存的大小：却绝育CPU的地址空间；
   + 32位：0x0000 0000 - 0xffff ffff 
3. 找存储位置，进行读 / 写操作。

## CPU

+ CPU总是周而复始地做同一件事 : 从内存取指令,然后解释执行它,然后再取下一条指令,再解释执行

### CPU 包含功能单元

1. Register ：

   + 是CPU内部的高速存储器，像内存一样可以存取数据，速度更快。

2. 程序计数器

   + 保存CPU取指令的地址，CPU读到地址后，按照地址去内存中取指令；
   + 取完本次指令后，指向内存中的下一条指令
   + 是CPU的特殊寄存器

3. 指令解码器

4. 算数逻辑单元 ALU

5. 地址和数据总线

   + 32位处理器有32条地址线和32条数据线
   + 可以表示一个32位的数

   {% asset_img AddressBus.png %}

## 设备

+ CPU除了访问内存外，还要访问很多Device

### 总线

1. 总线：正因为地址线和数据线上可以挂多个设备和内存芯片所以才叫“总线”,但不同的设备和内存应该占不同的地址范围。
2. 加载：操作系统在执行程序时，从硬盘拷贝到内存，这样CPU才可以取指令执行。
3. 进程：程序加载到内存后，成为操作系统调度执行的一个任务。
4. 中断：为了提供设备发送主动请求。
5. 中断处理的步骤：先判断哪个设备引发的中断，然后调用该设备驱动程序提供中断处理函数。
6. Linux内核源代码：绝大部分是设备驱动程序。
7. 设备驱动程序：是操作系统内核里的一组函数,主要是通过对设备寄存器的读写实现对设备的初始化、读、写等操作，有些设备还要提供一个中断处理函数供ISR调用。

| CPU访问的类别              | Memory                        | Device                           |
| -------------------------- | ----------------------------- | -------------------------------- |
| 访问方式                   | 按地址进行读写                | 按地址进行读写                   |
| 访问操作                   | a按地址找到存储单元，进行读写 | 给设备发一个命令，数据不一定保存 |
| 集成在处理器的芯片访问方式 |                               | 内存映射I/O，端口I/O             |
| 数据                       | 只保存数据                    | 产生新的数据                     |
| 请求                       | 被动等待读和写                | 主动发送请求                     |

## Memory Management Unit

### 虚拟内存管理 VIrtual Memory Management

1. 操作系统需要用VMM ：需要MMU的支持。
2. 物理地址：处理器没有MMU，CPU执行单元发送的**内存地址**将直接传到芯片引脚，被内存芯片（物理内存）接受。
3. 虚拟地址：CPU发送的**内存地址**被MMU捕获，从CPU到MMU的地址。

### 物理地址和虚拟地址

1. 32位的CPU：指CPU的寄存器是32位，数据总线是32位，虚拟地址空间是32位。
2. 物理地址的范围：取决于处理器芯片上的芯片引脚有多少条地址线，
3. 虚拟地址映射带物理地址：MMU进行管理分配，具体细节就不聊了。

### MMU 内存保护机制

1. MMU除了做地址转换（虚拟--物理）之外，还提供内存保护机制。
2. 内存保护机制：操作系统设置的访问权限。
   + 操作系统将虚拟地址空间划分为：用户空间和内核空间。
   + 中断：从用户空间切换到内核空间，处理异常。（用户空间的切换，必须有中断发起）

## Memory Hierachy

1. 计算机的存储器分为若干等级，按照离CPU的远近依次是：

   {% asset_img memory.png %}

2. 寄存器，Cache，内存中的数据都是掉电易丢失；

3. 寄存器访问：由程序指令直接控制之外；其他的存储器都不是由指令直接控制的。