---
layout: post
title: SerialBus
date: 2019-07-29 20:26:33
categories: emebeded
tags: Bus
---

# 嵌入式总线和接口

## [总线概述](https://www.crifan.com/summary_embedded_system_various_peripherals/)

1. 总线是一组线路, 或者是接口的总称;

2. 总线的功能: 

   + 任何一个**微处理器(MCU)** 都要与一定数量的部件和外围设备连接，常用一组线路，配置以适当的接口电路，与各部件和外围设备连接，这组共用的连接线路被称为总线。

3. [总线的分类](https://blog.csdn.net/zmc1216/article/details/21377949)

   
   
   | 总线类型     | 总线        | 功能                                                         |
   | ------------ | ----------- | ------------------------------------------------------------ |
   | **内部总线** | I2C         | 同步两线; **半**双工通信, 近距离;  通过**地址识别**多个设备(一对多连接); |
   | (近距离)     | SPI         | 同步四线**全**双工通信;                                      |
   |              | SCI         | 通用异步通信接口UART(全)，与MCS-51的**异步**通信功能基本相同 |
   | **外部总线** | RS-232      | 全双工; 25针的信号接口; **限于PC串口和点对点通信**;  20m 串行** |
   | (远距离)     | RS-485      | **半**双工; 多用于**多点互连**; **传输速率最远**(几十米到上千米); **并行** |
   |              | USB         | **半**双工; **传输速率最快的总线12Mbps**                     |
   |              | PCI / PCI-E | PCI是总线结构，而PCIe是点对点结构                            |
   |              | DMA         | 只需要CPU发送指令后，DMA使得内存和外部设备直接通信           |
   | 现场总线     | Can         | 不分主从; 单点, 多点广播通信; 自助关闭错误总线;(**CAN 是所有总线中最为可靠的**) |



## 串行内部总线

| 类型         | SPI                         | I2C                                                      | UART                                                         | USB                        |
| ------------ | --------------------------- | -------------------------------------------------------- | ------------------------------------------------------------ | -------------------------- |
| 信号线       | SCLK, MOSI, MISO, SS        | SDA, SCL                                                 | TXD, RXD                                                     | 4线VCC(5V)/GND/D+/D-(3.3V) |
| 全/半双工    | 全双工通信                  | 半双工                                                   | 全双工通信                                                   | 半双工                     |
| 同/异步总线  | 同步总线                    | 同步总线                                                 | **异步**总线                                                 | 同步总线                   |
| 距离         | 主从设备(近)                | IC之间,**短**                                            | 远(1200m)                                                    | 近                         |
| 各自特点     | 有自己**时钟协议**          | 1) 先发送目的设备的地址;                                 | **固定**的波特率                                             |                            |
| 传输速度     |                             |                                                          |                                                              | **最快的总线**: 12Mbps     |
| 可靠性       | 不可靠(无效验)              |                                                          | 可靠(校验位)                                                 |                            |
| 数据发送     | 空闲状态跳变                | 边缘触发                                                 | 起始位= 0                                                    |                            |
| 数据帧       | 从高bit--低bit ; 8bit(data) | 从高--低; <br />1) 7(adress) + 1(ack);  2)8(data) + 1ack | **从低bit--高**;  10bit / 11 bit<br />1bit(起始 0) + 8bit(data) + 1(校验) + 1bit(停止 1) |                            |
| 总线拓扑结构 | 环形                        | 总线型（特殊的树形）                                     |                                                              | 星形                       |



### [SPI 串行外设接口](https://blog.csdn.net/ce123_zhouwei/article/details/6897293)

1. SPI(Serial Peripheral Interface)
   - 全双工的通信, **同步**总线
   - 四条信号线: 串行时钟(SCLK)、串行数据输出(MOSI)、串行数据输入(MISO) ，SS(slave 从设备选择线)
     - SS : 低电平有效
   - IO口模拟SPI总线: 必须要有一个输出口(SDO)，一个输入口(SDI)
   
2. SPI 通信描述

   + 主从模式架构: 支持多slave模式应用，一般仅支持单Master
   + **主设备** :提供串行时钟(SCLK)
   + 通过**移位寄存器**实现主从设备的数据交换;

   {% asset_img SPI_data.png %}

3. **数据输出**

   + 空闲状态:  由时钟极性(CPOL)进行确定;  CPOL=0(同步时钟的空闲状态为低电平); PCOL=1(高)
   +  相位配置CPHA
  + CPHA=0 : 第一个跳变沿开始采样
     + CPHA=1  : 第二个跳变沿开始采样
   + 数据**按位**传输，**从高 -- 低**; 传输的数据为8位

   {% asset_img SPI_time.png %}

### I2C 同步总线

1. I2C(INTER IC BUS)

   - 信号线: 两线(SCL、SDA)、 **同步**总线
   - 特点: 具有**总线仲裁机制**，非常适合在器件之间进行**近距离**
   - 协议:  传输数据时都会带上**目的设备**的设备地址，因此可以实现**设备组网**
   - IO口模拟I2C总线:   并实现双向传输，则需一个输入输出口(SDA)，另外还需一个输出口(SCL)

2. 时序状态

   {% asset_img i2c_time.png %}
   
   + 三种类型的信号，分别是：开始信号、结束信号和应答信号
   + 开始信号：处理器让SCL时钟保持高电平，然后让SDA数据信号由高变低就表示一个开始信号。
   + 主机: 发送adress: 7bit (目的地址) + 读/ 写(bit);  等待ACK
   + 从机接受: 并且发送ACK确认
   + 主机发送数据:  **8bit (由高bit--低) **, 等待ACK
   + 从机接受:  并且发送ACK确认
   + 停止信号：处理器让SCL时钟保持高电平，然后让SDA数据信号由低变高就表示一个停止信号。
   
3. **问题一:  **数据传输中, 如何保持SDA上传输的数据的稳定?

   - 当**SCL为高电平**期间, SDA 发送的数据才能保持稳定;
   - 外接IIC设备在SCL为高电平的期间 : 采集数据方知SDA是高或低电平

4. **问题二: ** SDA数据在什么时候进行翻转?

   + 只能在**SCL为低电平**期间翻转变化
   + (如果当scl为高进行翻转的话, 代表停止和开始)

5. **问题三**: 处理器把数据发给外接IIC设备，如何知道IIC设备数据已经收到呢？

   + IIC设备向处理器发送**响应信号**（ACK）;
   + 处理器: 发完8bit数据后就不再驱动总线了（SDA引脚变输入）, 而SDA和SDL硬件设计时都有**上拉电阻**，所以这时候SDA变成高电平。
   + 外接IIC设备能收到信号: 在第9个周期拉低SDA，处理器检测到**SDA拉低**就能知道外接IIC设备数据已经收到。

   {% asset_img I2c_data.png %}

6. 上拉电阻起作用的情况?

   + 只有当SDA为输入脚时, 外部上拉的高电平才起作用;
   
7. IIC读写读写寄存器?

   + 都是主机向从机发起;
   + 主机向从机发送地址, 进行地址识别
   + 写寄存器
     + 主机将数据写到从机中
   + 读寄存器
     + 从机将数据发送给主机;

### [UART 通用异步收发器](https://www.cnblogs.com/liujinggang/p/9535366.html)

1. UART  (Universal Asynchronous Receiver Transmitter)

   - 特点:**异步**串口，因此一般比前两种同步串口的结构要复杂很多;
   - 接收方不知道发送方什么时候发送，所以在发送的信息中就要有提示接收方开始接收的信息，如开始位，结束时有停止位
   - 信号线: TXD, RXD;

2. UART 数据格式

   + 一个数据帧:   10bit / 11bit(有校验)
     + 起始位: 1bit  -- 为低0
     + data : 8bit , 从**低地址到高地址**;
     + 校验位 (1)
     + 停止位(1)  -- 为高1
   
   {% asset_img Uart_data.png %}
   
3. 数据发送和接收

   + 数据发送时: **一位位的进行发送**
   + 发送过程 : 
     + 空闲状态，线路处于高电位; 当收到发送数据指令后，拉低线路一个**数据位的时间T**;
     + 接着数据从**低--高**位依次发送(8bit); 接着发送奇偶校验位和停止位, 一帧资料发送结束;
   + 接受过程
     +  空闲状态，线路处于高电位; 当**检测**到线路的下降沿, 时说明线路有数据传输;
     + 按照约定的**波特率** , **从低 -- 高**位接收数据; 接着接收并**比较奇偶校验位**是否正确

   {% asset_img uart.png %}

4. 保证数据正确性

   + UART采用**16倍数据波特率**的时钟进行采样; 
   + 每个数据有16个时钟采样，取**中间**的采样值，以保证采样不会滑码或误码。

5. 发送数据时间计算

   ```
   波特率: 115200 bps    ;  Time (1bit)  = (1/115200)=8.7us;
   一帧数据: (不考虑奇偶bit) : ( 8 + 2 ) * 8.7 = 87us;
   1s(1000000us) : 字节数(1000000/87) = 11494bit;  -- > 11.5KB/s
   ```

   

## 外部总线

### RS - 232

1. RS-232 接口形式

   + 以9个引脚 (DB-9) ; 25个引脚 (DB-25) 
   + **串行**物理接口标准
   + 个人计算机上: **两组** RS-232 接口，分别称为 COM1 和 COM2.

   {% asset_img rs232.png %}

2. 传输距离短的原因:

   + RS-232-C标准规定，驱动器允许有2500pF的电容负载，通信距离将受此电容限制;
   + 是RS-232属**单端信号传送**(点对点)，存在共地噪声和不能抑制共模干扰等问题，因此一般用于20m以内的通信。

3. 信号线

   + RS-232-C总线标准设有**25条信号线**，包括一个主通道和一个辅助通道，在多数情况下主要使用**主通道**
   + 对于一般**双工通信**，仅需几条信号线就可实现，如一条RXD、一条TXD及一条地线

4. [RS232 通信协议](https://blog.csdn.net/mrdingjie/article/details/8126062)

   + 负逻辑电平:  信号电平与通常的TTL电平也不兼容，“1”(-5V～-15V)，“0”(+5V～+15V)
   + 实现OSI参考模型的: 物理层

### [RS - 485](https://www.diangon.com/wenku/rd/danpianji/201501/00017891.html)

1. 通信方式
   + RS-485采用**平衡发送和差分接收**，因此具有抑制共模干扰的能力。
   + 加上总线收发器具有高灵敏度，能检测低至200mV的电压，故传输信号能在**千米以外**得到恢复。
   + RS-485采用**半双工**，任何时候只能有一点处于发送状态，因此，发送电路须由**使能信号加以控制**
2. 应用地方:
   + RS-485用于**多点互连**时非常方便，可以省掉许多信号线。
   + 应用RS-485可以**联网构成分布式系统**，其允许最多**并联32**台驱动器和32台接收器。

### USB

1. USB总线的优势
   + 它可以为外设**提供电源**，而不像普通的使用串、并口的设备需要单独的供电系统;
   + USB的**最高传输率**可达12Mbps比串口快100倍，比并口快近10倍，而且USB还能支持多媒体
   + 支持热插拔 
2. 缺点
   + 不能通过USB进行计算机的**互连**

### PCI   Peripheral Component Interconnect (外设部件互连标准）

1. [PCI 外设部件互连标准](https://blog.csdn.net/u013253075/article/details/80835489)

   + 目前个人电脑中使用最为广泛的接口，几乎所有的[主板](https://baike.baidu.com/item/主板/104636)产品上都带有这种插槽

2. PCI的架构：

   + PCI 总线  +  PCI Bridge  +  PCI 总线域；
   + **PCI Bridge** : 隔离处理器系统的存储器域与PCI总线域；并完成处理器与PCI设备间的数据交换
   + 每个Host Bridge单独管理独立的总线空间，包括PCI Bus, PCI I/O, PCI Memory, and PCI

   {% asset_img pci.png %}

3. PCI总线的三部分

   {% asset_img pci_bus.png %}

   {% asset_img pci_bus_three.png %}

4.  PCI是总线结构，而PCIe是点对点结构

   + 被称为“串行PCI”，由于采用了串行方式传输使得其工作频率可以达到2.5Ghz
   + 每一个PCIe总线设备与外部通信时有四根数据总线，分别有两个RX和TX

## 现场总线

### Can

1. CAN 是控制器局域网络(Controller Area NetWork)的简称.
2. CAN 协议也遵循 ISO/OSI 模型，采用了其中的物理层、数据链路层与应用层。
3. 工作方式:
   + CAN 采用**多主**工作方式，节点之间不分主从;
   + 但节点之间有**优先级**之分，通信方式灵活;
   + 可实现**点对点**、**一点对多**及**广播方式**传输数据，无需调度;
4. 传输介质和距离
   + CAN 总线可采用双绞线，同轴电缆或光纤作力传输介质
   + 通信速率可达 1Mbps/40m，直接通信距离最远可达 10km/5Kbps。可挂接设备数最多可达**110 **个。
5. CAN总线的可靠性
   + CAN 的信号传输采用**短帧结构**，每帧有效字节为 8 个，传输距离短，受干扰的概率低。
   + 当节点严重错误时，具有**自动关闭功能**，以切断该节点与总线的联系，使总线上的其它节点及通信不受影响。
   + **可见，CAN 是所有总线中最为可靠的。**



| 信号和硬件接口关系 |                                                              |
| ------------------ | ------------------------------------------------------------ |
| 物理硬件接口       | 串口、COM口                                                  |
| 电平信号(电信号)   | TTL、RS232、RS485                                            |
|                    | TTL标准是低电平为0，高电平为1（±5V电平）                     |
|                    | RS-232标准是负逻辑(5-15v)                                    |
| PL2303、CP2102芯片 | USB转TTL串口的芯片,用USB来扩展串口(TTL电平)                  |
| MAX23芯片          | TTL电平与RS232电平的专用双向转换芯片                         |
| 接设备的时候注意:  | 一般只接GND RX TX。 不会接Vcc或者+3.3v的电源线，避免与目标设备上的供电冲突。 |



