---
layout: post
title: ARM体系结构
date: 2019-08-02 21:11:42
categories:	ARM
tags: 
---

# ARM体系结构

## ARM处理器的7种模式

| 处理器模式                         | 描述                                                       |
| ---------------------------------- | ---------------------------------------------------------- |
| 用户模式(User)                     | 正常程序执行模式; ARM指令地址加4byte, Thumb指令地址加2byte |
| 快速中断(FIQ)                      | 高速数据传输和通道处理                                     |
| 外部中断(IRQ)                      | 通常的中断处理                                             |
| 特权模式(Supervisor, sev)          | 供操作系统使用的一种保护模式                               |
| 数据访问中止(Abort, abt)           | 用于虚拟存储及存储保护                                     |
| 未定义指令中止模式(Undefined, und) | 支持通用软件方针硬件的协处理器                             |
| 系统模式(System, sys)              | 运行特权级的操作系统任务                                   |

1. 具体的区别:
   + 特权模式(Privileged Modes): 除了用户模式之外的其他6种;
   + 异常模式:  除了用户 和 系统模式,
2. 系统模式 :
   + 系统模式**不是**通过异常进入, 它和用户模式具有完全一样的寄存器;

### 寄存器介绍

1. ARM处理器有37个寄存器
   + 31个通用寄存器, 包含**程序计数器(PC)**, 都是32bit
   + 6个状态寄存器
2. 程序计数器(PC)的作用?
   + 是用于**存放执行指令**的地方;
   + 当执行指令时，CPU将自动修改PC的内容，即每执行一条指令PC增加一个量，这个量等于指令所含的字节数，以便使其**保持的总是将要执行的下一条指令的地址**
3. 程序状态寄存器(CPSR)
   + 包含条件标识位, 中断禁止位, 当前处理器模式标志位以及其他的控制位;

### 寄存器移位方式 : 知道前三种

| 移位方式 | 名称           |      |
| -------- | -------------- | ---- |
| ASR      | 算数右移       |      |
| LSL      | 逻辑左移       |      |
| LSR      | 逻辑右移       |      |
| ROR      | 循环右移       |      |
| RRX      | 扩展的循环右移 |      |



### ARM 处理器异常中断

1. 异常中断类型和优先级

   {% asset_img ARM_Interupt.jpg %}

2. 中断响应和返回

   + 保存处理器当前状态;
   + 设置CPSR中的位;
   + 将寄存器lr_mode设置为返回地址
   + 将计数器值(PC)设置为中断的向量地址;

   + 返回到中断情况的下一条指令;

3. FIQ和IRQ 异常中断?

   + 用于**外部设备**向CPU请求中断服务
   + 引脚低电平有效
   + 同时发生时: 先处理FIQ

## ARM 指令集可以分为哪六大类?

| 指令集 (6类)                | 功能                          |      |
| --------------------------- | ----------------------------- | ---- |
| 跳转指令                    | 直接向PC寄存器写入目的地址值; |      |
| 数据处理指令                | 对数据的处理                  |      |
| 程序状态寄存器(PSR)传输指令 | 读取--修改--写回;             |      |
| Load/Store 指令             |                               |      |
| 协处理器指令                | 支持16个协处理器              |      |
| 异常中断产生指令            | 软中断SWI; 断点中断指令BKPT   |      |

### 数据处理指令分类

1. 数据传送指令:
   + MOV 算数逻辑运算指令:  ADD(加法), SUB(减法), AND(逻辑与), MUL(乘法)
2. 比较指令: TST

### load/store 指令

| 指令集           | 名字                 |
| ---------------- | -------------------- |
| LDR (load data ) | **字**数据加载指令   |
| LDRB             | **字节**数据加载指令 |
| LDRH             | **半字**数据加载指令 |
| STR              | **字**数据存储指令   |
| STRB             | **字节**数据存储指令 |
| STRH             | **半字**数据存储指令 |

1. 位, 比特, 字节, 字四这之间的关系?
   + 位 : bit, 计算自内部**数据存储**最小的单位;
   + 字节:  B,  计算机内部**数据处理**的基本单位,  1Byte = 8 bit;
   + 字: word, 计算机进行数据处理时,**一次存取, 加工和传送的长度**
     + 一个字组成: 一个或者多个byte;
     + 取决于: CPU处理器的位数, 64bit, 32bit;

### 立即数寻址的方式

1. 立即数组成
   + 每个立即数由一个8bit常数, **循环右移**偶数位得到;

## ARM体系结构中的工作状态?

1. ARM体系结构有四种工作状态

   - ARM状态: arm处理器**工作**在**32bit**的指令状态, **字对齐**的ARM指令;
   - Thumb状态: arm处理器**工作**在**16bit**的指令状态, **半字对齐**ARM指令;
   - Thumb-2状态: 这个状态是ARM7版本的处理器, **兼容**32bit/16bit
   - 调试状态: 处理器**关闭**的状态;

2. ARM状态 <--->Thumb状态 的**切换**

   ```
    LDR R0=lable+1;  // 从ARM到Thumb :   状态寄存器的最低位设置为1,BX指令,  R0指令将进入thumb状态;
    LDR R0=lable; 		//  从Thumb到 ARM: 寄存器最低位设置为0，BX指令、R0指令将进入arm状态
   ```

3. **进入ARM状态的三种方式**:  

   - **寄存器**最低位设置为0, 由Thumb到 ARM;
   - 当处理器进行**异常处理**时，则从异常向量地址开始执行，将自动进入ARM状态。
   - ARM处理器**复位**后开始执行代码时总是只处于ARM状态；

4. 注意几个问题?

   - Cortex-M3 : 只有Thumb-2状态和调试状态；
   - Thumb-2技术: ARM处理器**无需**再ARM状态和Thumb-2状态间进行切换了，因为thumb-2具有32位指令功能;
   
5. ARPCS 的作用?

   + 是ARM程序和Thumb程序中**子程序**调用的基本规则

## ARM汇编

1. ARM 中的伪指令?
   + 伪指令在汇编编译器对源程序进行**汇编处理**时, 被**替换成**对应的ARM或者Thumb指令(序列)
2. AMR汇编语言中的符号?
   + 符号可以代表地址, 变量和数字变量;
3. ARM 汇编程序的格式
   + 以**段**为单位组织源文件(.c / .h);
     + 段: 具有相对独立, 特定名称, 不可分割的指令或者数据序列
   + 分为: 代码段和数据段

## 存储器管理单元MMU

### MMU 作用

1. 作用一: 完成虚拟空间到物理空间的映射;
   + 把虚拟地址空间分成一个个固定大小的块, 把物理内存的地址空间也分成同样大小的页;
   + 页的大小分为粗粒度和细粒度两种;
2. 作用二: 存储器访问权限控制
3. 作用三: 设置虚拟存储空间的缓冲特性;

### ARM中支持存储快大小

1. 段(Section): 大小为1M的存储块
2. 大页(Large Pages): 大小为64KB的存储块
3. 小页(small pages): 大小为 4KB的存储块
4. 极小页(Tiny Pages): 大小为1KB的存储块

## AMR 中的源文件

### ARM是C/C++编译器和连接器

{% asset_img armC_CPP.jpg %}

1. ARM的连接器
   + armlink

### ARM 映像文件

1. 映像文件(image)生成

   + 目标文件生成: ARM中各种源文件(.c, .s), 经过**编译器**生成ELF格式的目标文件
   + 目标文件 + 运行的库, 通过**ARM连接器**处理后 生成ELF格式的映像文件(image)

   ```
   $ armcc -g  -O1 -c main.c		// ARM 中.c文件编译
   $ tcc	-g	 -O1	-c main.c		// Thumb 中 .c文件编译
   ```

   

2. 映像文件(image)组成

   + 一个或者多个**域**(region)
   + 每个域包含一个或多个**输出段**
   + 每个输出段包含一个或多个**输入段**
   + 各输入段包含目标文件中的**代码和数据**

3. ARM映像文件的入口点

   + a) 运行时入口点, **初始化入口点**;
     + 地址: 0x0 为嵌入式应用系统入口点
     + **唯一** 的一个入口点
   + b) 普通入口点entry point;
     + **多个**entry point
     + 包含各种异常中断的入口点
   + 如果一个映像文件只有一个普通入口点, 就是初始入口点;

### ARM 系统复位

1. 系统复位时, 地址0x0是从ROM开始? 

   + ARM体系结构中, 系统复位后跳转到地址0x0处执行, 存放的是复位异常中断的中断向量;

   + 系统复位时: RAM中不存在代码和数据;

   + 地址0x0处: 应该是从ROM中开始指向;

2. 系统正常运行时, 地址0x0处为RAM

### ARM 体系中的调试

1. 基于Angel的调试系统
   + 主机上的调试器(debugger)
   + 位于目标主机上的Angel调试监控程序
2. 基于JTAG的调试系统