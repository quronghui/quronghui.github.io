<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="嵌入式实时操作系统实时系统 和 实时内核 实时系统的概念? 系统要求: 对任务 处理结果的正确性 和 处理过程的实时性 都有严格要求的系统. 硬实时和软实时系统的区别:  对处理过程超时及超时带来的后果的容忍度; 硬实时: 不允许处理过程超时     前后台系统的分类 前台结构(中断级): 中断服务程序(ISR)用于处理系统的异步事件; 后台结构(任务级): 应用程序是一个无限的循环, 循环中调用">
<meta name="keywords" content="uC-OS-III">
<meta property="og:type" content="article">
<meta property="og:title" content="uC&#x2F;OS-III">
<meta property="og:url" content="http://yoursite.com/2019/08/19/uC-OS-III/index.html">
<meta property="og:site_name" content="Lucky Boy">
<meta property="og:description" content="嵌入式实时操作系统实时系统 和 实时内核 实时系统的概念? 系统要求: 对任务 处理结果的正确性 和 处理过程的实时性 都有严格要求的系统. 硬实时和软实时系统的区别:  对处理过程超时及超时带来的后果的容忍度; 硬实时: 不允许处理过程超时     前后台系统的分类 前台结构(中断级): 中断服务程序(ISR)用于处理系统的异步事件; 后台结构(任务级): 应用程序是一个无限的循环, 循环中调用">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/osctxsw.png">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/ISR_direct.png">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/SIGNAL.png">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/单向同步.png">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/TASK_SEM.png">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/双向任务.png">
<meta property="og:image" content="http://yoursite.com/2019/08/19/uC-OS-III/flag.png">
<meta property="og:updated_time" content="2020-07-23T13:28:54.590Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="uC&#x2F;OS-III">
<meta name="twitter:description" content="嵌入式实时操作系统实时系统 和 实时内核 实时系统的概念? 系统要求: 对任务 处理结果的正确性 和 处理过程的实时性 都有严格要求的系统. 硬实时和软实时系统的区别:  对处理过程超时及超时带来的后果的容忍度; 硬实时: 不允许处理过程超时     前后台系统的分类 前台结构(中断级): 中断服务程序(ISR)用于处理系统的异步事件; 后台结构(任务级): 应用程序是一个无限的循环, 循环中调用">
<meta name="twitter:image" content="http://yoursite.com/2019/08/19/uC-OS-III/osctxsw.png">






  <link rel="canonical" href="http://yoursite.com/2019/08/19/uC-OS-III/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>uC/OS-III | Lucky Boy</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lucky Boy</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">you and me</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archives"></i> <br>Archiv</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-categories"></i> <br>Kategorien</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Suche</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/19/uC-OS-III/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ronghui Qu">
      <meta itemprop="description" content="Lucky Smile">
      <meta itemprop="image" content="/images/home.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lucky Boy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">uC/OS-III

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2019-08-19 18:18:12" itemprop="dateCreated datePublished" datetime="2019-08-19T18:18:12+08:00">2019-08-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Updated at: 2020-07-23 21:28:54" itemprop="dateModified" datetime="2020-07-23T21:28:54+08:00">2020-07-23</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Operate-System/" itemprop="url" rel="index"><span itemprop="name">Operate System</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article"></span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time"></span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="嵌入式实时操作系统"><a href="#嵌入式实时操作系统" class="headerlink" title="嵌入式实时操作系统"></a>嵌入式实时操作系统</h1><h2 id="实时系统-和-实时内核"><a href="#实时系统-和-实时内核" class="headerlink" title="实时系统 和 实时内核"></a>实时系统 和 实时内核</h2><ol>
<li>实时系统的概念?<ul>
<li>系统要求: 对<strong>任务</strong> <em>处理结果</em>的<strong>正确性</strong> 和 <em>处理过程</em>的<strong>实时性</strong> 都有严格要求的系统.</li>
<li>硬实时和软实时系统的区别: <ul>
<li>对处理过程超时及超时带来的后果的<strong>容忍度</strong>;</li>
<li>硬实时: 不允许处理过程超时</li>
</ul>
</li>
</ul>
</li>
<li>前后台系统的分类<ul>
<li>前台结构(<strong>中断级</strong>): <strong>中断服务程序</strong>(ISR)用于处理系统的<strong>异步事件</strong>;</li>
<li>后台结构(<strong>任务级</strong>): <strong>应用程序</strong>是一个<strong>无限的循环</strong>, 循环中调用相应的函数完成相应的操作;</li>
<li>任务的响应延迟: 应用程序<strong>循环</strong>到该任务时, 花费的时间;  </li>
</ul>
</li>
<li>RTOS(real-time- Operating system) 系统和内核的区别?<ul>
<li>实时系统: 内核 + 高层系统服务(文件系统, 协议栈)</li>
</ul>
</li>
</ol>
<h3 id="实时内核-uC-OS-III"><a href="#实时内核-uC-OS-III" class="headerlink" title="实时内核(uC/OS-III)"></a>实时内核(uC/OS-III)</h3><ol>
<li>uC/OS-III 定义?<ul>
<li>定义: 是一个可裁剪, 可固化, 可剥夺的<strong>多任务内核</strong>, 管理的任务数目不受限制;</li>
<li>本质: 实时内核(用于管理的软件代码)</li>
</ul>
</li>
<li><strong>实时内核(uC/OS-III )的作用</strong>?<ul>
<li>作用: 负责<strong>管理</strong>这些任务的调度, 使得<strong>CPU</strong>在多个任务之间进行<strong>切换</strong>;<ul>
<li>任何时刻, 单个CPU只能执行一个任务;</li>
</ul>
</li>
<li>多任务: 系统功能被分成多个任务, 每个任务(线程)完成一个功能;</li>
<li>可剥夺型内核: <ul>
<li>在任何时刻都可以发生<strong>任务调度</strong>, 任务调度使得CPU总是运行处于<strong>就绪状态</strong>并且<strong>最高优先级</strong>的任务;</li>
</ul>
</li>
<li>多任务数目受限 : 受限于RAM的大小;</li>
</ul>
</li>
<li>uC/OS-III 的特性<ul>
<li>极短的关中断时间: 通过锁定内核调度的方式, 不是通过关中断方式保护<strong>临界段</strong>, 使得关闭中断时间降到最低;</li>
<li><strong>确定性</strong>: 中断响应时间确定;</li>
<li>出错检验:  err = OS_ERR_NONE</li>
<li>防止死锁: 通过超时检测机制;</li>
<li>时钟节拍处理: 通过时钟节拍进行处理;</li>
<li>中断服务程序: 函数内部不能有<strong>阻塞</strong>(等待), 中断处理的时间总是很短;</li>
</ul>
</li>
<li>本书命名规则<ul>
<li>以”OS_”开头</li>
<li>调试工具: uC/Probe</li>
</ul>
</li>
</ol>
<h3 id="uC-OS-III-软硬件结构"><a href="#uC-OS-III-软硬件结构" class="headerlink" title="uC/OS-III 软硬件结构"></a>uC/OS-III 软硬件结构</h3><ol>
<li><p>硬件结构</p>
<ul>
<li><p>PCU + 定时器 + 中断控制器</p>
</li>
<li><p>通用异步收发器(UART) + ADC + 以太网控制器;</p>
</li>
</ul>
</li>
<li><p>软件结构</p>
<ul>
<li>应用程序 + 相关代码 …</li>
</ul>
</li>
</ol>
<h2 id="uC-OS-III-代码描述"><a href="#uC-OS-III-代码描述" class="headerlink" title="uC/OS-III 代码描述"></a>uC/OS-III 代码描述</h2><h3 id="应用程序"><a href="#应用程序" class="headerlink" title="应用程序"></a>应用程序</h3><ol>
<li><p>应用程序完成过程?</p>
<ul>
<li>用户调用uC/OS-III提供的一系列<strong>函数</strong>(任务)完成相应的功能;</li>
<li>函数作用: 管理信号量/消息队列/互斥信号量;</li>
</ul>
</li>
<li><p>每个任务(线程)?</p>
<ul>
<li>在RTOS中, 任务也称之为线程;</li>
<li>每个任务多有属于自己的<strong>栈</strong>;</li>
</ul>
</li>
<li><p>单任务的应用程序执行过程? </p>
<ul>
<li><p>1)<strong>启动关中断</strong>:  启动代码引导CPU, 从main()函数开始执行; </p>
</li>
<li><p>关闭中断: 保证系统启动期间<strong>中断关闭</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">BSP_IntDisAll</span>();		<span class="comment">// 关闭所有中断</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2)<strong>初始化内核</strong>,创建任务: 初始化内部变量和数据结构, 创建2-5个任务(至少两个)</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_Init(<span class="meta">&amp;err);	<span class="comment">//   先初始化, 才能使用</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>空闲任务: OS_IdleTask()<ul>
<li>在其他任务不就绪时, 就运行空闲任务, 为了保证CPU处于运行状态;</li>
</ul>
</li>
<li>时钟节拍任务: <ul>
<li>负责时间管理;</li>
</ul>
</li>
</ul>
</li>
<li><p>3) 创建任务</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_TaskCreate<span class="comment">()</span>;	<span class="comment">// 创建任务, 先创建在使用</span></span><br></pre></td></tr></table></figure>
<ul>
<li>为每个任务分配: TCB + 堆栈 + 优先级 + 其他参数;</li>
<li>只能内核进行访问, 应用程序不能访问;</li>
</ul>
</li>
<li><p>4) 执行任务</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_Stat()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后: </p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">应用程序中的每一个任务都必须调用一个可以引发任务**等待某事件**的函数<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>多任务应用程序创建执行过程?</p>
<ul>
<li>存在临界区共享问题;</li>
</ul>
</li>
</ol>
<h3 id="临界区代码保护"><a href="#临界区代码保护" class="headerlink" title="临界区代码保护"></a>临界区代码保护</h3><ol>
<li><p>临界区代码的保护方式?</p>
<ul>
<li><p><strong>关中断: </strong> ISR 和任务 都能访问的代码;</p>
</li>
<li><p><strong>调度器上锁</strong> : 仅任务能访问的代码;</p>
</li>
<li>参数配置起效果</li>
</ul>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os_cfg.h</span><br><span class="line">	OS_CFG_ISR_POST_DEFERRED_EN == <span class="number">0</span> ;	<span class="comment">// 使用关中断方式</span></span><br><span class="line">	OS_CFG_ISR_POST_DEFERRED_EN == <span class="number">1</span> ;	<span class="comment">// 使用调度器上锁的方式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测量中断关闭时间</p>
<ul>
<li><p>设置寄存器</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CPU_CFG_INT_DIS_MESA_EN</span> == <span class="number">1</span>;		// 打开后,才能测量中断时间</span><br></pre></td></tr></table></figure>
</li>
<li><p>测量两个时间: 总的关闭中断时间 和 每个任务中断关闭时间;</p>
</li>
<li><p>计算: 从中断关闭时开始计时, 到重新打开中断;</p>
</li>
<li><p>单位: 与系统时间戳CPU_TS的单位一致</p>
</li>
</ul>
</li>
<li><p>测量调度器上锁时间, 类似</p>
<ul>
<li>设置寄存器</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CPU_CFG_SCHED_LOCK_TIME_MESA_EN</span> == <span class="number">1</span>;		// 打开后,才能测量调度器锁定时间</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="任务的介绍"><a href="#任务的介绍" class="headerlink" title="任务的介绍"></a>任务的介绍</h2><ol>
<li><p>多任务等待单个内核对象?</p>
<ul>
<li>四个内核对象</li>
</ul>
</li>
<li><p>多任务同时等待多个内核对象?</p>
<ul>
<li><p>只允许多信号量 和 多个消息队列; 不允许同时等待事件标志组和互斥型信号量;</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">OSPendMulti</span><span class="params">()</span></span>	<span class="comment">// 一旦有对象被发送, 那么OSPendMulti立即返回;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h3><ol>
<li><p>任务的概念描述?</p>
<ul>
<li>定义: 是一个线程, 也就是一个简单的程序;</li>
<li>分类: 运行至完成型; 无限循环型;</li>
</ul>
</li>
<li><p>任务和C函数的区别?</p>
<ul>
<li>任务执行过程: 是顺序的无限循环;</li>
<li><strong>任务执行完后: 不允许返回;</strong></li>
<li>任务和c函数: 通过使用参数传递, 实现函数的可重入性;</li>
</ul>
</li>
<li><p><strong>任务管理的概念</strong>?</p>
<ul>
<li>多任务的调度, 和CPU使用权的切换</li>
</ul>
</li>
<li><p>任务<strong>优先级</strong>的分配?</p>
<ul>
<li>优先级的值 = 任务索引下标</li>
<li>优先级: [0, N-1]<ul>
<li>0 : 优先级最高, 留给ISR</li>
<li>[1, N-1] : 分配给不同的任务</li>
</ul>
</li>
<li>允许: 多任务拥有统一由县级</li>
</ul>
</li>
<li><p>每个任务分配的<strong>堆栈空间</strong>?</p>
<ul>
<li>分配但不释放:<ul>
<li>动态分配堆栈空间, 但是不允许释放, 否则会存在空间碎片;</li>
</ul>
</li>
<li>堆栈溢出检测:<ul>
<li>OS_TCB中的成员 .StkLimitPtr 指针: 指向分配空间的位置;</li>
<li>栈空间的阈值:  无限接近MyTaskStk[0]</li>
</ul>
</li>
<li>栈空间分配的大小<ul>
<li>计算值 * 安全系数(1.5/2)</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>任务的5种状态?</strong></p>
<ul>
<li><strong>休眠态</strong><ul>
<li>代码已经写入代码空间, 但是uC/OS-III 不知道它的存在;</li>
<li>任务删除: 并不是删除代码, 而是使其无法获得CPU使用权</li>
</ul>
</li>
<li>就绪态<ul>
<li>任务<strong>准备运行</strong>时, 就会进入这个状态;</li>
<li>就绪表: 用于对任务优先级进行排序;</li>
</ul>
</li>
<li>运行态<ul>
<li>优先级最高的任务进入;</li>
<li>单核CPU: 任何时刻只有一个任务进入该状态;</li>
</ul>
</li>
<li>等待态<ul>
<li>当一个任务所等待的事件没有发生时, 进入等待</li>
<li>等待时: 不消耗CPU事件, 会调用下一个优先级的任务进行执行;</li>
</ul>
</li>
<li>中断服务态<ul>
<li>允许CPU中断时, 当前任务会被挂起, CPU开始执行ISR</li>
</ul>
</li>
</ul>
</li>
<li><p>处于uC/OS-III 内部任务的8种状态?</p>
<ul>
<li>就绪: 任务实现其功能的唯一途径;</li>
<li>延时: 任务可以让自己延时等待一段时间</li>
<li>等待: 任务等待某个事件的发生, 不发生就一直等待;</li>
<li>带超时检测的等待: 等待超时时才能运行</li>
<li>被挂起: 运行中的任务被挂起, 在恢复前是不能获得CPU的使用权的<ul>
<li>恢复: 其他任务来恢复该任务的运行状态</li>
</ul>
</li>
<li>等待且被挂起: 在等待状态被挂起<ul>
<li>恢复: 当等待的事件发生, 并且挂起状态取消, 任务才能运行</li>
</ul>
</li>
<li>带超时检测的等待且被挂起:</li>
</ul>
</li>
<li><p><strong>系统内部(的五个任务)?</strong></p>
<ul>
<li><p><strong>空闲任务</strong>(必须创建)</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_IdleTask<span class="comment">()</span> , os_core.c;		<span class="comment">// 当其他任务都处于未就绪状态时, 空闲任务运行</span></span><br></pre></td></tr></table></figure>
<ul>
<li>空闲任务运行时, 两个计数器不断递增<ul>
<li>OSIdleTaskCtr: 表示空闲任务的活跃度</li>
<li>OSStatTaskCtr: 统计程序运行是CPU的利用情况</li>
</ul>
</li>
<li>优先级最低: 为(n-1)</li>
</ul>
</li>
<li><p><strong>时钟节拍任务</strong>(必须创建)</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_TickTask<span class="comment">()</span>, os_tick.c;		<span class="comment">// 实时操作系统的时钟源</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用于跟踪任务延时和任务等待超时;</li>
<li>硬件定时器: 10-1000Hz</li>
</ul>
</li>
<li><p>统计任务</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_StatTask<span class="comment">()</span>, os_stat.c;	<span class="comment">// 可以再系统运行时, 统计CPU的利用率</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定时器任务</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">OS_TmrTask</span><span class="params">()</span></span>, os_tmr.c</span><br></pre></td></tr></table></figure>
<ul>
<li>定时器是一个递减的计数器, 当计数器减为0时, 就会做一个操作</li>
<li>操作: 回调函数</li>
</ul>
</li>
<li><p>中断服务管理任务</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">OS_InitQTask</span><span class="params">()</span></span>, os_int.c</span><br></pre></td></tr></table></figure>
<ul>
<li>禁止或者打开中断, 给调度器上锁或者解锁;</li>
<li>优先级最高, 为0;</li>
<li>不允许存在阻塞;</li>
</ul>
</li>
</ul>
</li>
<li><p>CPU实际利用率计算?<br>$$<br>CPU = 100 - (100 * OSStatTaskCtr )/OSStatTaskCtrMax<br>$$</p>
<ul>
<li><p>当OSStatTaskCtr计数到最大值时</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OSStatTaskCtr = [0, 10 000 000];</span><br><span class="line"><span class="section">实际的最大值: 7500 000;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>应用程序的运行会花费 : CPU = 25% 的时间;</p>
</li>
</ul>
</li>
</ol>
<h3 id="任务就绪表"><a href="#任务就绪表" class="headerlink" title="任务就绪表"></a>任务就绪表</h3><ol>
<li><p>任务就绪表由两部分组成:</p>
<ul>
<li><p>就绪任务优先级位映射表</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OSPrioTbl</span><span class="selector-attr">[  ]</span>;   <span class="comment">// priority , 用于标记哪个优先级下有任务就绪</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>就绪任务列表</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OSRdyList</span><span class="selector-attr">[  ]</span>;	<span class="comment">// 记录每一个优先级下所有就绪的任务</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>查找就绪任务</p>
<ul>
<li>优先级 == 索引号</li>
<li>顺序查找就绪任务优先级位映射表, 直到遇到第一个非零位</li>
<li>至少会找到一个就绪任务而结束;  – 空闲任务列表</li>
</ul>
</li>
</ol>
<h3 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a>任务调度</h3><ol>
<li><p>任务调度的概念:</p>
<ul>
<li>负责确定下一个要执行的任务; </li>
<li>可剥夺型:<ul>
<li>当一个事件发生(每个任务都会等待事件发生);  <strong>也就是任务将信号量释放或者发布消息时;</strong></li>
<li>并且使得更高优先级的任务就绪时, CPU的控制权就会被剥夺, 转交给更高优先级的任务</li>
</ul>
</li>
</ul>
</li>
<li><p>同一优先级的任务执行</p>
<ul>
<li>采用时间片轮转的方式执行;</li>
<li>时间片的长度 = n * 时钟节拍</li>
</ul>
</li>
<li><p><strong>uC/OS-III 存在两个调度器</strong></p>
<ul>
<li><p>任务级调度: </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">OSSched</span><span class="params">()</span></span>  -- &gt; OSCtxSw()		<span class="comment">// 任务调度函数入口 -- &gt; 任务切换功能函数</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<ul>
<li><p>ISR中断服务程序调度:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">OSIntExit</span><span class="params">()</span></span> -- &gt; OSIntCtxSw()	<span class="comment">// ISR调度函数入口 -- &gt; 中断任务切换功能函数;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="任务切换"><a href="#任务切换" class="headerlink" title="任务切换"></a>任务切换</h3><ol>
<li><p>任务切换</p>
<ul>
<li>过程: <strong>保存</strong>当前任务现场(CPU相关寄存器)到当前任务的堆栈中, <strong>恢复</strong>新的优先级最高的任务现场;</li>
<li>时间: 取决于多少寄存器需要保护和恢复;</li>
</ul>
</li>
<li><p>虚构CPU的15个寄存器 + 状态寄存器</p>
<ul>
<li>R0-R13 : 正常的寄存器</li>
<li>R14: 任务级堆栈指针(TSP) ; R14’ : 中断堆栈指针(ISP)<ul>
<li>SP指针指向最后一个入栈的寄存器R13(栈顶)</li>
<li>TSP 和 ISP 存在于不同的内存区域;</li>
</ul>
</li>
<li>R15: 程序计数器(PC)<ul>
<li>PC和SR 先进入堆栈中</li>
</ul>
</li>
<li>SR:  状态寄存器</li>
</ul>
</li>
<li><p>具体的切换过程</p>
<ul>
<li><strong>保存:</strong> 每个任务都有一套堆栈寄存器, 任务运行在cpu的堆栈寄存器中, 当任务切换时, 将cpu的寄存器值保存在当前任务的堆栈中</li>
<li><strong>恢复: </strong> 在返回时, 同时恢复CP和SR</li>
<li>两个切换函数, 对应任务级和ISR级</li>
</ul>
<img src="/2019/08/19/uC-OS-III/osctxsw.png">
</li>
<li><p>注意: OSIntCtxSw()</p>
<ul>
<li>仅需要执行任务切换的后半部分工作, 因为uC/OS-III 进入终端服务程序时, CPU寄存器已经得到保存</li>
</ul>
</li>
</ol>
<h3 id="中断管理"><a href="#中断管理" class="headerlink" title="中断管理"></a>中断管理</h3><ul>
<li>多个中断发生时, 应该怎么处理;</li>
</ul>
<ol>
<li><p>实时多任务内核的重要指标: 中断关闭总时间</p>
<ul>
<li>定义: 内核在运行临界区代码前<strong>关闭中断</strong>, 在临界区代码完成后<strong>重新打开中断</strong>;</li>
<li>这段时间: 中断关闭的总时间</li>
</ul>
</li>
<li><p>中断中其他时间定义 </p>
<ul>
<li><strong>时钟(系统)节拍</strong>: 只有器存在, 才能测量时间; </li>
<li>中断延迟时间: 最大中断关闭时间;</li>
<li>中断响应时间: 中断被识别 – &gt; ISR中断代码开始运行的时间;</li>
<li>中断恢复时间: ISR代码运行完毕 – &gt; 下一个任务代码开始运行的时间;</li>
<li>任务等待时间: 从中断发生 – &gt; 任务代码重新开始执行的时间;</li>
</ul>
</li>
<li><p>中断控制器的作用?</p>
<ul>
<li>作用: 处理多个中断请求, 为其<strong>设置</strong>优先级, <strong>记录</strong>哪些中断还未处理, 并将最高优先级的中断ISR的<strong>地址传递</strong>给CPU;</li>
<li>优先级定义:<ul>
<li>16个中断优先级[15,0], 优先级最高是15</li>
<li>中断优先级 &gt; 任务优先级</li>
</ul>
</li>
</ul>
</li>
<li><p>中断服务程序ISR?</p>
<ul>
<li>所有中断源共用同一个ISR:<ul>
<li>缺点: 必须对一个中断请求源处理<strong>全部完成</strong>, 才可能处理新发生的<strong>更高中断级</strong>别请求;</li>
<li>造成所有中断延迟时间最长;</li>
</ul>
</li>
<li>每个中断源拥有单独的ISR;<ul>
<li>根据中断向量表, 直接跳转到对应的ISR</li>
<li>允许 : 中断嵌套;</li>
</ul>
</li>
</ul>
</li>
<li><p>直接发布和延时发布?</p>
<ul>
<li><p>针对: 从<strong>中断中</strong>发布消息或者信号; (每个任务都会等待一个事件发生)</p>
</li>
<li><p>选择: 取决于中断响应时间, 任务响应时间的要求;</p>
</li>
<li><p>直接发布:</p>
<ul>
<li><p>采用关中断的方式, 保护临界区代码, 防止ISR访问临界区代码;</p>
<img src="/2019/08/19/uC-OS-III/ISR_direct.png">
</li>
</ul>
</li>
<li><p>延时发布:</p>
<ul>
<li>采用给调度器上锁的方式, 保护临界区代码;</li>
<li>增加: 中断队列</li>
</ul>
</li>
</ul>
<h3 id="任务挂起表"><a href="#任务挂起表" class="headerlink" title="任务挂起表"></a>任务挂起表</h3><ol>
<li>任务挂起表的作用?<ul>
<li>当一个任务等待<strong>内核对象的发生时</strong>, 将该任务放在挂起表(等待表)中;</li>
<li>内核对象: 信号量 / 互斥信号量 / 事件标志组 / 消息队列</li>
<li>任务挂起表: 跟踪正在等待内核对象的任务;</li>
</ul>
</li>
<li>任务挂起表组成<ul>
<li>由OS_PEND_LIST类型的结构体组成, 并且进一步封装到另外一个数据类型OS_PEND_OBJ;</li>
</ul>
</li>
<li>任务如何链接任务挂起表?<ul>
<li>表中的任务: 不直接链接到任务挂起表; 通过一个中间数据结构OS_PEND_DATA进行链接;</li>
<li>将等待内核对象的任务放入挂起表的同时, 将该数据结构放到该任务的栈空间中;</li>
</ul>
</li>
</ol>
</li>
</ol>
<h2 id="uC-OS-III-的管理"><a href="#uC-OS-III-的管理" class="headerlink" title="uC/OS-III 的管理"></a>uC/OS-III 的管理</h2><h3 id="时间管理"><a href="#时间管理" class="headerlink" title="时间管理"></a>时间管理</h3><ol>
<li><p>uC/OS-III提供一种延时服务?</p>
<ul>
<li>任务可以将自己挂起, 延时一段指定时间, 当指定时间结束后在运行;</li>
</ul>
</li>
<li><p>延时的时间长度指定方式</p>
<ul>
<li>时钟(系统)节拍</li>
<li>小时/分/秒/毫秒</li>
</ul>
</li>
<li><p>时间接口函数</p>

</li>
</ol>
<h3 id="定时器管理"><a href="#定时器管理" class="headerlink" title="定时器管理"></a>定时器管理</h3><ol>
<li><p>定时器的本质?</p>
<ul>
<li>定时器是一个<strong>递减计数器</strong>;</li>
<li>当其值递减到零时, 自定义的<strong>回调函数</strong>就会立即被调用;</li>
<li>回调函数 : 在<strong>定时器任务</strong>内完成, 此时调度器是上锁的, 回调函数不允许任何阻塞调用;</li>
</ul>
</li>
<li><p>定时器创建?</p>
<ul>
<li><p>定时器需要先创建后使用</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSTmrCreate<span class="comment">()</span>;		<span class="comment">// 创建定时器并指定其运行模式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建以后: 启动(重启) , 停止 任意次数;</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSTmrStart<span class="comment">()</span>;	<span class="comment">// 启动或者重启定时器</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>定时器运行的第三种模式?</p>
<ul>
<li><p>单次运行模式</p>
<ul>
<li>dly(节拍数) &gt; 0; period(周期) == 0;</li>
<li>计数器从dly开始, 递减到0时, 就调用回调函数,之后就不在进行定时</li>
<li>除非使用OSTmrStart(), 启动或者重启定时器</li>
</ul>
</li>
<li><p>周期定时器(无初始延时)</p>
<ul>
<li>dly(节拍数)==  0; period(周期) &gt; 0;</li>
<li>计数器递减到0时, 重新设置初值为period, 重新计数</li>
</ul>
</li>
<li><p>周期定时器(有初始延时)</p>
<ul>
<li>dly(节拍数) &gt; 0; period(周期) &gt; 0;</li>
<li>第一个周期有dly设置, 后面的周期由period设置;</li>
</ul>

</li>
</ul>
</li>
<li><p>定时器的状态?</p>

</li>
</ol>
<h3 id="共享资源的管理"><a href="#共享资源的管理" class="headerlink" title="共享资源的管理"></a>共享资源的管理</h3><ol>
<li>共享资源好处和弊端?<ul>
<li>共享内存能让任务之间的<strong>信息交互</strong>变得简单;</li>
<li>但造成了任务对数据的<strong>独占性</strong>造成了影响;</li>
</ul>
</li>
<li>共享资源的种类?<ul>
<li>不同任务处于同一寻址空间时, 就会造成数据共享问题;</li>
<li>种类: 变量(static and 全局), 数据结构体, RAM中的表格, I/O设备中的寄存器;</li>
</ul>
</li>
<li>最常用的独占资源和创建临界区的方法?<ul>
<li>关中断;</li>
<li>禁止任务调度;</li>
<li>使用信号量</li>
<li>使用互斥型信号量;</li>
</ul>
</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>任务等待某事件发生的方式?<ul>
<li>等待资源的任务: 执行等待, 或者挂起操作;</li>
<li>超时等待<ul>
<li>time &gt; 0: 只愿意在一段时间内等待时间; 事件不发生, 任务进入就绪状态等待运行, 并且任务返回等待超时错误</li>
<li>time = 0: 任务一直处于等待事件的状态;</li>
</ul>
</li>
<li>阻塞/非阻塞<ul>
<li><strong>阻塞:  等同于 – 任务会一直等待事件的发生; </strong><ul>
<li>调度器就会介入, CPU会执行另外一个优先级高的就绪任务;</li>
</ul>
</li>
<li>非阻塞: 任务在就绪状态, 事件未发生, 则返回错误;</li>
</ul>
</li>
</ul>
</li>
<li>解决死锁问题?<ul>
<li>任务先得到全部资源, 在做下一步工作</li>
<li>任务用相同的顺序盛情多个资源;(不用全部获取)</li>
<li>在调用请求信号量的函数时, 设置超时时间;</li>
</ul>
</li>
</ol>
<h4 id="关中断-开中断"><a href="#关中断-开中断" class="headerlink" title="关中断/开中断"></a>关中断/开中断</h4><ol>
<li>使用条件?<ul>
<li>共享资源访问的速度很快, 小于中断关闭的时间;</li>
<li>关闭所有的中断(接收不到其他的中断请求)</li>
</ul>
</li>
<li>弊端<ul>
<li>影响系统的中断延迟时间; </li>
</ul>
</li>
</ol>
<h4 id="给调度器上锁"><a href="#给调度器上锁" class="headerlink" title="给调度器上锁"></a>给调度器上锁</h4><ol>
<li>使用条件?<ul>
<li>任务不需要和ISR共享资源;</li>
<li>原因: 虽然给调度器上锁, 但是此时中断一旦发生, 即便在<strong>临界区</strong>内, 该任务也会被挂起, 执行ISR程序; 但是虽然造成更高优先级任务就绪, 但是此时处于上锁状态; 中断返回后, 仍然执行挂起任务;</li>
</ul>
</li>
<li>调度器上锁时: 禁止用户使用阻塞型调用;</li>
</ol>
<h4 id="信号量-多用于同步"><a href="#信号量-多用于同步" class="headerlink" title="信号量 (多用于同步)"></a>信号量 (多用于同步)</h4><ol>
<li><p>信号量使用的条件?</p>
<ul>
<li>只有任务级才能使用, ISR不能使用;</li>
<li>先创建才能使用;</li>
<li>引入信号量: 不会增加系统的中断延迟;</li>
</ul>
</li>
<li><p>信号量分类</p>
<ul>
<li>二值信号量: 1/0</li>
<li>计数型信号量: 初始化一个信号量的值</li>
</ul>
</li>
<li><p>信号量导致一个问题 –  任务级反转?</p>
<ul>
<li>H的优先级最高, 等待L发布一个事件: 但是此时最低优先级L占用共享资源;</li>
<li>同时中等优先级的M等待的事件发生: 此时剥夺L的CPU使用权, 运行完后返回给L;</li>
<li>最后, L运行完后, 释放信号给H, 此时H运行;</li>
<li>结果: 最高优先级H, 最后才运行;</li>
</ul>

</li>
</ol>
<h4 id="互斥型信号量-MUTEX"><a href="#互斥型信号量-MUTEX" class="headerlink" title="互斥型信号量(MUTEX)"></a>互斥型信号量(MUTEX)</h4><ol>
<li>MUTEX使用的条件?<ul>
<li>只有任务级才能使用, ISR不能使用;</li>
<li>对共享资源的访问, 有<strong>截止时间限制</strong>的任务;</li>
<li>解决: 任务反转的问题;</li>
</ul>
</li>
<li>MUTEX如何解决 任务反转的问题?<ul>
<li>优先级集成的方式;</li>
<li>一旦出现高优先的任务H访问共享资源, 占有该资源的任务优先级将被提升到与H一样的优先级;</li>
<li>完成访问后, 会恢复到原先优先级</li>
</ul>
</li>
</ol>
<h2 id="任务同步"><a href="#任务同步" class="headerlink" title="任务同步"></a>任务同步</h2><ol>
<li>任务同步的概念?<ul>
<li>任务 : 与中断服务程序(ISR) 或者 其他任务进行同步;</li>
<li>同步概念: 当ISR执行时, 可以通过给任务发信号, 告诉该任务等待的事件发生; ISR完成后退出, 调度程序根据信号和优先级完成调度;</li>
<li>任务不能同步ISR; (ISR 不能阻塞,且时间要短)</li>
</ul>
</li>
<li>任务同步方式?<ul>
<li>ISR和任务可以通过三种方式: 向一个或多个任务发信号</li>
<li>信号量 / 任务信号量 / 事件标志组;</li>
</ul>
</li>
<li>信号量和任务信号量 区别?<ul>
<li>信号量: 需要声明一个外部信号量对象;</li>
<li>信号任务量: <ul>
<li>创建任务时自动创建, 适用于给单个任务发信号;</li>
<li>信号任务量服务函数的速度 &gt; 信号量的服务函数;</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><ol>
<li><p>信号量的API?</p>
<ul>
<li>先创建才能使用;</li>
</ul>
<img src="/2019/08/19/uC-OS-III/SIGNAL.png">
</li>
<li><p>单向同步:</p>
<ul>
<li>例子: I/O操作</li>
<li>任务 – &gt; 同步任务 ;  ISR – &gt; 同步任务</li>
</ul>
<img src="/2019/08/19/uC-OS-III/单向同步.png">
</li>
<li><p>信用记录</p>
<ul>
<li>信号量可以被发布多次;</li>
<li>当任务优先级位于就绪状态是, 该任务会被连续执行多次, 执行次数与发布次数相同;</li>
</ul>
</li>
<li><p>多个任务等待同一个信号量</p>
<ul>
<li>广播: 使得等待同一信号的任务, 否处于就绪状态, 执行优先级最高的任务;</li>
</ul>
</li>
</ol>
<h3 id="任务信号量"><a href="#任务信号量" class="headerlink" title="任务信号量"></a>任务信号量</h3><ol>
<li><p>任务信号量的使用条件?</p>
<ul>
<li>任务信号量: 内嵌信号量, 创建任务时, 自动被创建;</li>
<li><strong>明确知道</strong>该给哪个任务发信号;</li>
</ul>
</li>
<li><p>任务信号量的API</p>
<img src="/2019/08/19/uC-OS-III/TASK_SEM.png">
<ul>
<li>OS_TaskSemPost() : 将目地任务控制块的地址作为其参数;</li>
</ul>
</li>
<li><p>双向同步</p>
<ul>
<li>双向同步, 只能用于任务之间, 不能用于ISR之间</li>
</ul>
<img src="/2019/08/19/uC-OS-III/双向任务.png">
</li>
</ol>
<h3 id="事件标志组"><a href="#事件标志组" class="headerlink" title="事件标志组"></a>事件标志组</h3><ol>
<li><p>事件标志组的使用条件?</p>
<ul>
<li>当任务需要与多个事件同时发生同步时, 使用事件标志组 ;</li>
<li>同步机制: 或同步, 与同步;</li>
</ul>
</li>
<li><p>使用事件标志时?</p>
<ul>
<li>所有满足等待条件的任务都会进入就绪状态; (类似于广播)</li>
<li>只有任务: 才能创建和删除flag;</li>
<li>任务和ISR: 都能发布标志</li>
</ul>
</li>
<li><p>事件标志组API接口?</p>
<img src="/2019/08/19/uC-OS-III/flag.png">
</li>
</ol>
<h2 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h2><ol>
<li>消息传递的作用?<ul>
<li>当一个任务或者ISR: 和另外一个任务<strong>交流消息</strong>时,;</li>
<li>信息传递称之为: 任务间通信;</li>
<li>任务在等待消息时: 不占用CPU处理时间;</li>
</ul>
</li>
<li>任务间信息传递的方式?<ul>
<li>全局变量: 任务 与 ISR之间通信只能使用<ul>
<li>全局变量的值: 需要进行查询才能得到</li>
</ul>
</li>
<li>发布消息: <ul>
<li>使用消息队列间接发布;</li>
<li>直接发布给任务</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="消息的发布"><a href="#消息的发布" class="headerlink" title="消息的发布"></a>消息的发布</h3><ol>
<li>消息的本质: 指向消息(数据)的指针;</li>
<li>消息包含几个部分:<ul>
<li>指向数据的指针, 表明数据长度的变量, 记录消息发布时刻的时间戳;</li>
<li>消息发布: 使用引用传递, 不是值传递;(不发生值的拷贝)</li>
</ul>
</li>
<li>消息必须保持<strong>可见性</strong>?<ul>
<li>可见性: 消息变量必须在接收消息任务代码范围内有效;</li>
<li>指针传递消息, 必须保持数据不能被改变;</li>
</ul>
</li>
<li>消息的创建<ul>
<li>消息通过OS_MSG结构体发布, uC/OS-III 维护着一个OS_MSG消息缓冲池;</li>
<li>发布消息时: 通过uC/OS-III从空闲的OS_MSG消息缓冲池中获取可用的OS_MSG;</li>
</ul>
</li>
</ol>
<h3 id="消息队列的种类"><a href="#消息队列的种类" class="headerlink" title="消息队列的种类?"></a>消息队列的种类?</h3><ol>
<li>外部消息队列:<ul>
<li>需要进行创建才能使用</li>
<li>适用于: 多任务都需要等待一个消息队列中的消息时, 分配一个OS_Q对象;</li>
</ul>
</li>
<li>任务内建消息队列<ul>
<li>用户明确: 消息目的接受任务</li>
<li>适用于: 单任务等待消息</li>
</ul>
</li>
</ol>
<h3 id="消息发布的例子"><a href="#消息发布的例子" class="headerlink" title="消息发布的例子"></a>消息发布的例子</h3><ol>
<li>双向同步<ul>
<li>需要使用<em>两个**</em>消息队列**(外部/内建)进行同步;</li>
<li>每个消息队列只能容忍一则消息</li>
</ul>
</li>
<li>流量控制<ul>
<li>生产者和消费者模型: 只有生产者产生数据, 消费者才能消费数据;</li>
<li>流量控制: 数据大小进行控制;</li>
</ul>
</li>
<li>客户端与服务端消息传递</li>
</ol>
<h2 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h2><ol>
<li><p>存储空间的动态分配?</p>
<ul>
<li>使用malloc() 和 free() 动态分配和释放存储空间</li>
<li>缺陷: 产生存储碎片, 函数执行时间无法确定;</li>
</ul>
</li>
<li><p>uC/OS-III 提供一种替代函数的方法?</p>
<ul>
<li>将连续的大块存储空间进行<strong>分区</strong>管理;</li>
<li>每个分区中包含整数个大小相同的<strong>存储快</strong>;</li>
<li>只使用malloc() 进行分配, 不释放空间;</li>
</ul>
</li>
<li><p>应用程序申请的空间: 得到不同分区中, 不同大小的存储快;</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSMem???<span class="comment">()</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="uC-OS-III-的移植"><a href="#uC-OS-III-的移植" class="headerlink" title="uC/OS-III 的移植"></a>uC/OS-III 的移植</h2>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/uC-OS-III/" rel="tag"># uC-OS-III</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/05/TheLinuxCommandLine/" rel="next" title="TheLinuxCommandLine">
                <i class="fa fa-chevron-left"></i> TheLinuxCommandLine
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/24/Linux设备驱动的开发详解/" rel="prev" title="Linux设备驱动的开发详解">
                Linux设备驱动的开发详解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/home.jpg" alt="Ronghui Qu">
            
              <p class="site-author-name" itemprop="name">Ronghui Qu</p>
              <p class="site-description motion-element" itemprop="description">Lucky Smile</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">107</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">69</span>
                    <span class="site-state-item-name">Kategorien</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">90</span>
                    <span class="site-state-item-name">Tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#嵌入式实时操作系统"><span class="nav-number">1.</span> <span class="nav-text">嵌入式实时操作系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实时系统-和-实时内核"><span class="nav-number">1.1.</span> <span class="nav-text">实时系统 和 实时内核</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实时内核-uC-OS-III"><span class="nav-number">1.1.1.</span> <span class="nav-text">实时内核(uC/OS-III)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uC-OS-III-软硬件结构"><span class="nav-number">1.1.2.</span> <span class="nav-text">uC/OS-III 软硬件结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uC-OS-III-代码描述"><span class="nav-number">1.2.</span> <span class="nav-text">uC/OS-III 代码描述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#应用程序"><span class="nav-number">1.2.1.</span> <span class="nav-text">应用程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#临界区代码保护"><span class="nav-number">1.2.2.</span> <span class="nav-text">临界区代码保护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#任务的介绍"><span class="nav-number">1.3.</span> <span class="nav-text">任务的介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#任务管理"><span class="nav-number">1.3.1.</span> <span class="nav-text">任务管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务就绪表"><span class="nav-number">1.3.2.</span> <span class="nav-text">任务就绪表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务调度"><span class="nav-number">1.3.3.</span> <span class="nav-text">任务调度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务切换"><span class="nav-number">1.3.4.</span> <span class="nav-text">任务切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中断管理"><span class="nav-number">1.3.5.</span> <span class="nav-text">中断管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务挂起表"><span class="nav-number">1.3.6.</span> <span class="nav-text">任务挂起表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uC-OS-III-的管理"><span class="nav-number">1.4.</span> <span class="nav-text">uC/OS-III 的管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#时间管理"><span class="nav-number">1.4.1.</span> <span class="nav-text">时间管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定时器管理"><span class="nav-number">1.4.2.</span> <span class="nav-text">定时器管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#共享资源的管理"><span class="nav-number">1.4.3.</span> <span class="nav-text">共享资源的管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关中断-开中断"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">关中断/开中断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#给调度器上锁"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">给调度器上锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#信号量-多用于同步"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">信号量 (多用于同步)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#互斥型信号量-MUTEX"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">互斥型信号量(MUTEX)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#任务同步"><span class="nav-number">1.5.</span> <span class="nav-text">任务同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#信号量"><span class="nav-number">1.5.1.</span> <span class="nav-text">信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务信号量"><span class="nav-number">1.5.2.</span> <span class="nav-text">任务信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件标志组"><span class="nav-number">1.5.3.</span> <span class="nav-text">事件标志组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息传递"><span class="nav-number">1.6.</span> <span class="nav-text">消息传递</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息的发布"><span class="nav-number">1.6.1.</span> <span class="nav-text">消息的发布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息队列的种类"><span class="nav-number">1.6.2.</span> <span class="nav-text">消息队列的种类?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息发布的例子"><span class="nav-number">1.6.3.</span> <span class="nav-text">消息发布的例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#存储管理"><span class="nav-number">1.7.</span> <span class="nav-text">存储管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uC-OS-III-的移植"><span class="nav-number">1.8.</span> <span class="nav-text">uC/OS-III 的移植</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ronghui Qu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total"></span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="Reading time total"></span>
  
</div>


  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
      
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="true"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
